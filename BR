(function executeRule(current, previous /*null when async*/) {

    var answers = new HGC_ACDC_Utils().saveAssessementToBusinessApps(current, false);
    var businessApps = Object.keys(answers);

    businessApps.forEach(function(app) {
        var grCCBA = new GlideRecord('cmdb_ci_business_app');
        if (grCCBA.get(app)) {
            var field = "u_critical_application_risk";
            var previousRisk = grCCBA.getValue(field);
            var currentRisk = "";

            // Simple logic: if any sensitive data exists, risk = Yes
            var hasGLBA = parseInt(answers[app].u_glba, 10) > 0;
            var hasSensitive = parseInt(answers[app].u_sensitive, 10) > 0;
            var hasCommercial = parseInt(answers[app].u_sensitive_commercial, 10) > 0;
            var hasPCI = parseInt(answers[app].u_pci, 10) > 0;
            var hasHIPAA = parseInt(answers[app].u_hipaa_hitech, 10) > 0;

            if (hasGLBA || hasSensitive || hasCommercial || hasPCI || hasHIPAA) {
                currentRisk = "Yes";
            } else {
                currentRisk = "No";
            }

            var riskChangedFromNoToYes = previousRisk == "No" && currentRisk == "Yes";
            var riskChangedFromYesToNo = (previousRisk == "Yes" || previousRisk == "YesRBAC") && currentRisk == "No";

            if (riskChangedFromNoToYes || riskChangedFromYesToNo) {
                //generate the req
                new HGC_ACDC_Utils().generateRBACRequest(app, current.sys_id, currentRisk);
            } else {
                //save
                new HGC_ACDC_Utils().saveAssessementToBusinessApps(current, true, app);
            }
        }
    });

})(current, previous);
