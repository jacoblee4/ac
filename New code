var HGC_ACDC_Utils = Class.create();
HGC_ACDC_Utils.prototype = {

    initialize: function() {

    },

    generateRBACRequest: function(appID, assessmentID, newRiskValue) {

        var grCCBA = new GlideRecord('cmdb_ci_business_app');
        if (grCCBA.get(appID)) {

            /*var ritm = new GlideRecord("sc_req_item");
            ritm.addActiveQuery();
            ritm.addQuery('cmdb_ci', grCCBA.sys_id);  
            //ritm.addEncodedQuery('cat_item=4862631edb509550b37a622dca96197f');
            ritm.query();*/

            //^ORcat_item=8dafbd3edbf82b0032049447db96199c^ORcat_item=627927ffdb7a7fc0d51c9ac5db9619da



            var cartId = GlideGuid.generate(null);
            var cart = new Cart(cartId); //calling the cart API
            var item = cart.addItem('4862631edb509550b37a622dca96197f'); //RBAC Manage ACDC Survey
            cart.setVariable(item, 'requested_for', grCCBA.owned_by);
            cart.setVariable(item, 'opened_by', grCCBA.owned_by);
            cart.setVariable(item, 'critical_application', newRiskValue);
            cart.setVariable(item, 'assessment_record', assessmentID);
            cart.setVariable(item, 'business_application', grCCBA.sys_id);
            var rc = cart.placeOrder();

            var req = new GlideRecord('sc_req_item');
            req.addQuery('request', rc.sys_id);
            req.query();
            while (req.next()) {
                req.cmdb_ci = grCCBA.sys_id;
                req.description = req.comments = "Created because the 'Critical Application (Risk)' is changing from " + grCCBA.u_critical_application_risk.getDisplayValue() + " to " + newRiskValue;
                req.comments = "Created because the 'Critical Application (Risk)' is changing from " + grCCBA.u_critical_application_risk.getDisplayValue() + " to " + newRiskValue;
                req.update();
            }
            gs.addInfoMessage("RBAC Manage ACDC Survey Request was created");
        }

    },



    saveAssessementToBusinessApps: function(current, save, appID) {

        var answers = {};
        var instance = current.getUniqueValue();

        gs.info("JPTESTING: Starting saveAssessmentToBusinessApps with instance: " + instance + ", save: " + save + ", appID: " + appID);

        // NEW: Function to check if yes/no question is answered "yes" AND count multi-select options
        function checkScenarioWithMinimumSelections(instance, businessApp, nameField, otherField, minimumSelections) {
            gs.info("JPTESTING: Checking scenario for businessApp: " + businessApp + ", nameField: " + nameField + ", otherField: " + otherField + ", minimumSelections: " + minimumSelections);

            // First check if the yes/no question is answered "yes" (1)
            var grName = new GlideRecord('asmt_assessment_instance_question');
            grName.addQuery("source_id", businessApp);
            grName.addQuery("instance", instance);
            grName.addQuery("metric.name", nameField);
            grName.query();

            gs.info("JPTESTING: Name field query returned " + grName.getRowCount() + " records");

            var nameAnswered = false;
            while (grName.next()) {
                var nameValue = grName.getValue("value");
                gs.info("JPTESTING: Name field " + nameField + " has value: " + nameValue);
                if (nameValue == "1") {
                    nameAnswered = true;
                }
            }

            if (!nameAnswered) {
                gs.info("JPTESTING: Name field not answered 'yes', returning false");
                return false;
            }

            // Now count how many "other" options are selected
            var grOther = new GlideRecord('asmt_assessment_instance_question');
            grOther.addQuery("source_id", businessApp);
            grOther.addQuery("instance", instance);
            grOther.addQuery("metric.name", otherField);
            grOther.query();

            gs.info("JPTESTING: Other field query returned " + grOther.getRowCount() + " records");

            var selectedCount = 0;
            while (grOther.next()) {
                var otherValue = grOther.getValue("value");
                gs.info("JPTESTING: Other field " + otherField + " has value: " + otherValue);
                if (otherValue && otherValue != "0" && otherValue != "") {
                    selectedCount++;
                }
            }

            gs.info("JPTESTING: Selected count: " + selectedCount + ", minimum required: " + minimumSelections);
            var result = selectedCount >= minimumSelections;
            gs.info("JPTESTING: Scenario check result: " + result);

            return result;
        }

        function getMetricValue(instance, businessApp, field) {
            var grAAIQ = new GlideRecord('asmt_assessment_instance_question');
            grAAIQ.addQuery("source_id", businessApp);
            grAAIQ.addQuery("instance", instance);
            grAAIQ.addQuery("metric.name", field);
            grAAIQ.query();
            if (grAAIQ.next()) {
                var value = grAAIQ.getValue("value");
                gs.info("JPTESTING: getMetricValue for " + field + " returned: " + value);
                return value;
            }
            gs.info("JPTESTING: getMetricValue for " + field + " returned empty");
            return "";
        }

        // Updated scenario definitions - now just need the field names and minimum selections required
        var scenarioDefinitions = [
            // { 
            // 	"nameField": "glba_customer_name", 
            // 	"otherField": "glba_other", 
            // 	"ciField": "u_glba", 
            // 	"asField": "glba_how_many",
            // 	"minimumSelections": 2
            // },
            {
                "nameField": "pci_data",
                "otherField": "pci_other",
                "ciField": "u_pci",
                "asField": "pci_how_many",
                "minimumSelections": 2
            },
            {
                "nameField": "hipaa_hitech_data",
                "otherField": "hipaa_yes",
                "ciField": "u_hipaa_hitech",
                "asField": "hipaa_how_many",
                "minimumSelections": 2
            },
            // { 
            // 	"nameField": "sensitive1_private_client_name", 
            // 	"otherField": "sensitive1_other", 
            // 	"ciField": "u_sensitive", 
            // 	"asField": "sensitive1_how_many",
            // 	"minimumSelections": 2
            // },
            {
                "nameField": "sensitive2_employee_info",
                "otherField": "sensitive2_yes",
                "ciField": "u_sensitive",
                "asField": "sensitive2_how_many",
                "minimumSelections": 2
            }
        ];

        var fieldValues = {};
        var businessApps = [];

        // Get all business apps for this instance
        var agg = new GlideAggregate('asmt_assessment_instance_question');
        agg.addAggregate('COUNT', 'source_id');
        agg.addQuery("instance", instance);
        agg.orderBy('source_id');
        agg.query();
        while (agg.next()) {
            var businessApp = agg.getValue('source_id');
            businessApps.push(businessApp);
            gs.info("JPTESTING: Found business app: " + businessApp);
        }

        gs.info("JPTESTING: Total business apps found: " + businessApps.length);

        businessApps.forEach(function(businessApp) {
            gs.info("JPTESTING: Processing business app: " + businessApp);

            scenarioDefinitions.forEach(function(scenarioDefinition) {
                gs.info("JPTESTING: Processing scenario definition for " + scenarioDefinition.ciField);

                // Check if this scenario meets the new requirements (yes + 2+ selections)
                if (checkScenarioWithMinimumSelections(
                        instance,
                        businessApp,
                        scenarioDefinition.nameField,
                        scenarioDefinition.otherField,
                        scenarioDefinition.minimumSelections
                    )) {
                    gs.info("JPTESTING: Scenario matched! Getting field value for " + scenarioDefinition.asField);
                    var fieldValue = getMetricValue(instance, businessApp, scenarioDefinition.asField);

                    gs.info("JPTESTING: Field value retrieved: " + fieldValue);

                    // Keep the maximum value logic
                    fieldValues[scenarioDefinition.ciField] = fieldValues[scenarioDefinition.ciField] || fieldValue;
                    if (fieldValues[scenarioDefinition.ciField] < fieldValue) {
                        fieldValues[scenarioDefinition.ciField] = fieldValue;
                    }

                    gs.info("JPTESTING: Final field value for " + scenarioDefinition.ciField + ": " + fieldValues[scenarioDefinition.ciField]);
                } else {
                    gs.info("JPTESTING: Scenario did not match");
                    // If scenario doesn't match, ensure field is set to 0 if not already set
                    if (!fieldValues[scenarioDefinition.ciField]) {
                        fieldValues[scenarioDefinition.ciField] = 0;
                        gs.info("JPTESTING: Set " + scenarioDefinition.ciField + " to 0");
                    }
                }
            });

            // Update the business app records
            gs.info("JPTESTING: About to update business app records. FieldValues: " + JSON.stringify(fieldValues));

            Object.keys(fieldValues).forEach(function(ciField) {
                gs.info("JPTESTING: Updating field " + ciField + " with value " + fieldValues[ciField]);
                var app = new GlideRecordUtil().getGR("cmdb_ci", businessApp);
                if (app.isValid()) {
                    gs.info("JPTESTING: Business app record found and valid");
                    app.setValue(ciField, fieldValues[ciField]);
                    answers[businessApp] = answers[businessApp] || {};
                    answers[businessApp][ciField] = fieldValues[ciField];
                    if ((save && !appID) || (save && appID && businessApp == appID)) {
                        gs.info("JPTESTING: Updating record...");
                        app.update();
                        gs.info("JPTESTING: Record updated successfully");
                    } else {
                        gs.info("JPTESTING: Record not updated due to save/appID conditions. save: " + save + ", appID: " + appID + ", businessApp: " + businessApp);
                    }
                } else {
                    gs.info("JPTESTING: Business app record not found or invalid for ID: " + businessApp);
                }
            });
        });

        gs.info("JPTESTING: Final answers: " + JSON.stringify(answers));
        return answers;
    },



    type: 'HGC_ACDC_Utils'
};
